<!DOCTYPE html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content="I am a developer, specialising in front-end web and native application development."><title>Create SEO friendly AngularJS app | David Chin</title><link rel=canonical href="http://davidchin.me/blog/create-seo-friendly-angularjs-app/"><link rel=stylesheet href="http://fonts.googleapis.com/css?family=Fira+Sans:300,400,700,300italic,400italic,700italic"><link rel=stylesheet href=/css/application.0c6f.css><script>window.disqus_shortname = "davidchin-blog"</script></head><body class=""><header class=global-header><div class=global-header__container><nav class=global-navigation><button id=navicon-button class=navicon-button><i class="navicon-button__icon ion-navicon"></i></button><ul class=global-navigation__menu><li><a href=/blog>Blog</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><a href="/" class=global-header__logo>David Chin</a></div></header><article><header class=page-header><div class=page-header__container><h1 class=page-header__title>Create SEO friendly AngularJS app</h1></div></header><div class=page-content><div class=content-column><div class=blog-article><p class=blog-article__meta><strong>angularjs</strong> / 10 January 2015 / <a href=/blog/create-seo-friendly-angularjs-app/#disqus_thread data-disqus-identifier="/blog/create-seo-friendly-angularjs-app/">0 Comments</a></p><p>The biggest problem with AngularJS is that pages you built with it cannot be directly crawled by search engines, because their content is dynamically rendered and therefore not visible in the source code. To get around this problem, you have to pre-render your pages on the server using a JavaScript-enabled headless browser, such as PhantomJS, and then cache the result so that the server doesn’t get hit when crawlers visit the same page again.</p><h2 id=using-a-third-party-service>Using a third-party service</h2><p>The simplest way to achieve this is to use a third-party service, such as <a href="https://prerender.io/">prerender.io</a> It is a paid service (free if you only have less than 250 pages). It is very good and I recommend using it for client projects because you don’t have to waste client’s money to tackle a problem that is already solved by someone else (and the cost is cheap).</p><h2 id=roll-your-own>Roll your own</h2><p>However, if you just want to play around with the concept, you can read on. I managed to make Rails-backed AngularJS app indexable by doing the following things.</p><h3 id=install-phantomjs>Install PhantomJS</h3><p>Firstly, install PhantomJS as a Node module <code>npm install --save phantomjs</code>. This will update your <code>package.json</code> and install PhantomJS in your <code>node_modules</code> folder.</p><h3 id=rails-middleware>Rails middleware</h3><p>Secondly, create a middleware that intercepts all incoming requests.</p><p>In <code>config/initializer/snapshot.rb</code></p><div class=highlight><pre><code class=language-ruby data-lang=ruby><span class=nb>require</span> <span class=s1>&#39;snapshot/renderer&#39;</span>

<span class=no>YourApplication</span><span class=o>::</span><span class=no>Application</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>middleware</span><span class=o>.</span><span class=n>use</span><span class=p>(</span><span class=no>Snapshot</span><span class=o>::</span><span class=no>Renderer</span><span class=p>)</span></code></pre></div><p>In <code>lib/snapshot/renderer.rb</code></p><div class=highlight><pre><code class=language-ruby data-lang=ruby><span class=k>module</span> <span class=nn>Snapshot</span>
  <span class=k>class</span> <span class=nc>Renderer</span>
    <span class=c1># A list of bots that don&#39;t support _escaped_fragment_</span>
    <span class=no>BOTS</span> <span class=o>=</span> <span class=o>[</span>
      <span class=s1>&#39;baiduspider&#39;</span><span class=p>,</span>
      <span class=s1>&#39;facebookexternalhit&#39;</span><span class=p>,</span>
      <span class=s1>&#39;twitterbot&#39;</span><span class=p>,</span>
      <span class=s1>&#39;rogerbot&#39;</span><span class=p>,</span>
      <span class=s1>&#39;linkedinbot&#39;</span><span class=p>,</span>
      <span class=s1>&#39;embedly&#39;</span><span class=p>,</span>
      <span class=s1>&#39;bufferbot&#39;</span><span class=p>,</span>
      <span class=s1>&#39;quora link preview&#39;</span><span class=p>,</span>
      <span class=s1>&#39;showyoubot&#39;</span><span class=p>,</span>
      <span class=s1>&#39;outbrain&#39;</span><span class=p>,</span>
      <span class=s1>&#39;pinterest&#39;</span><span class=p>,</span>
      <span class=s1>&#39;developers.google.com/+/web/snippet&#39;</span><span class=p>,</span>
      <span class=s1>&#39;slackbot&#39;</span>
    <span class=o>]</span>

    <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
      <span class=vi>@app</span> <span class=o>=</span> <span class=n>app</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
      <span class=n>fragment</span> <span class=o>=</span> <span class=n>parse_fragment</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>

      <span class=k>if</span> <span class=n>fragment</span>
        <span class=n>render_fragment</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>fragment</span><span class=p>)</span>
      <span class=k>elsif</span> <span class=n>bot_request?</span><span class=p>(</span><span class=n>env</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>page_request?</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
        <span class=n>fragment</span> <span class=o>=</span> <span class=p>{</span> <span class=ss>path</span><span class=p>:</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;REQUEST_PATH&#39;</span><span class=o>]</span><span class=p>,</span> <span class=ss>query</span><span class=p>:</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=o>]</span> <span class=p>}</span>
        <span class=n>render_fragment</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>fragment</span><span class=p>)</span>
      <span class=k>else</span>
        <span class=vi>@app</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
      <span class=k>end</span>
    <span class=k>end</span>

    <span class=kp>private</span>

    <span class=k>def</span> <span class=nf>parse_fragment</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
      <span class=n>regexp</span> <span class=o>=</span> <span class=sr>/(?:_escaped_fragment_=)([^&amp;]*)/</span>
      <span class=n>query</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;QUERY_STRING&#39;</span><span class=o>]</span>
      <span class=n>match</span> <span class=o>=</span> <span class=n>regexp</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>

      <span class=c1># Interpret _escaped_fragment_ and figure out which page needs to be rendered</span>
      <span class=p>{</span> <span class=ss>path</span><span class=p>:</span> <span class=no>URI</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>match</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>),</span> <span class=ss>query</span><span class=p>:</span> <span class=n>query</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=n>regexp</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>}</span> <span class=k>if</span> <span class=n>match</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>render_fragment</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>fragment</span><span class=p>)</span>
      <span class=n>url</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=si>#{</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;rack.url_scheme&#39;</span><span class=o>]</span> <span class=si>}</span><span class=s2>://</span><span class=si>#{</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;HTTP_HOST&#39;</span><span class=o>]</span> <span class=si>}#{</span> <span class=n>fragment</span><span class=o>[</span><span class=ss>:path</span><span class=o>]</span> <span class=si>}</span><span class=s2>&quot;</span>
      <span class=n>url</span> <span class=o>+=</span> <span class=s2>&quot;?</span><span class=si>#{</span> <span class=n>fragment</span><span class=o>[</span><span class=ss>:query</span><span class=o>]</span> <span class=si>}</span><span class=s2>&quot;</span> <span class=k>if</span> <span class=n>fragment</span><span class=o>[</span><span class=ss>:query</span><span class=o>].</span><span class=n>present?</span>

      <span class=c1># Run PhantomJS</span>
      <span class=n>body</span> <span class=o>=</span> <span class=sb>`node_modules/.bin/phantomjs lib/snapshot/browser.js </span><span class=si>#{</span> <span class=n>url</span> <span class=si>}</span><span class=sb> --load-images=false`</span>

      <span class=c1># Output pre-rendered response</span>
      <span class=n>status</span><span class=p>,</span> <span class=n>headers</span> <span class=o>=</span> <span class=vi>@app</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
      <span class=n>response</span> <span class=o>=</span> <span class=no>Rack</span><span class=o>::</span><span class=no>Response</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>body</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>headers</span><span class=p>)</span>
      <span class=n>response</span><span class=o>.</span><span class=n>finish</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>bot_request?</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
      <span class=n>user_agent</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;HTTP_USER_AGENT&#39;</span><span class=o>]</span>
      <span class=n>buffer_agent</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;X-BUFFERBOT&#39;</span><span class=o>]</span>

      <span class=n>buffer_agent</span> <span class=o>||</span> <span class=p>(</span><span class=n>user_agent</span> <span class=o>&amp;&amp;</span> <span class=no>BOTS</span><span class=o>.</span><span class=n>any?</span> <span class=p>{</span> <span class=o>|</span><span class=n>bot</span><span class=o>|</span> <span class=n>bot</span><span class=o>.</span><span class=n>include?</span><span class=p>(</span><span class=n>user_agent</span><span class=o>.</span><span class=n>downcase</span><span class=p>)</span> <span class=p>})</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>page_request?</span><span class=p>(</span><span class=n>env</span><span class=p>)</span>
      <span class=nb>method</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;REQUEST_METHOD&#39;</span><span class=o>]</span> <span class=o>||</span> <span class=s1>&#39;GET&#39;</span>
      <span class=n>accept</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;HTTP_ACCEPT&#39;</span><span class=o>]</span>
      <span class=n>path</span> <span class=o>=</span> <span class=n>env</span><span class=o>[</span><span class=s1>&#39;REQUEST_PATH&#39;</span><span class=o>]</span>

      <span class=c1># Only return true if it is a GET request, accepting text/html response</span>
      <span class=c1># not hitting API endpoint, and not requesting static asset</span>
      <span class=nb>method</span><span class=o>.</span><span class=n>upcase</span> <span class=o>==</span> <span class=s1>&#39;GET&#39;</span> <span class=o>&amp;&amp;</span>
      <span class=n>accept</span> <span class=o>=~</span> <span class=sr>/text\/html/</span> <span class=o>&amp;&amp;</span>
      <span class=o>!</span><span class=p>(</span><span class=n>path</span> <span class=o>=~</span> <span class=sr>/^\/(?:assets|api)/</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
      <span class=o>!</span><span class=p>(</span><span class=n>path</span> <span class=o>=~</span> <span class=sr>/\.[a-z0-9]{2,4}$/i</span><span class=p>)</span>
    <span class=k>end</span>
  <span class=k>end</span>
<span class=k>end</span></code></pre></div><p>Essentially what the middleware does is, if the incoming request is a GET request accepting text/html (and not looking for a static asset in the public directory, or hitting an API endpoint), it will ask PhantomJS to render the web page. The headless browser will return HTML containing the the page content (replacing AngularJS template code with actual content). Once the output is returned, the middleware passes it down to the next middleware on the stack, which eventually gets returned to the search engine.</p><p>If you look at the code, you’ll see that it looks for <code>_escaped_fragment_</code> first. That’s because of the <a href=https://developers.google.com/webmasters/ajax-crawling/docs/specification>Ajax-crawling specification</a> implemented by Google and Bing. It just means that if your application uses hash fragments (#!) or HTML5 history API to fetch pages using AJAX, the search engine automatically requests theses pages using a special URL instead. For example <code>http://domain.com/recipes/123</code> maps to <code>http://domain.com?_escaped_fragment_=/recipes/123</code> The purpose of this is to give the server an opportunity to return static crawlable content instead of JavaScript templates. Please note that if you use pushState to generate pretty URLs, you need to explicitly tell the crawler by putting <code>&lt;meta name="fragment" content="!"&gt;</code> in <code>head</code></p><h3 id=configure-phantomjs>Configure PhantomJS</h3><p>Thirdly, in <code>lib/snapshot/browser.js</code></p><div class=highlight><pre><code class=language-javascript data-lang=javascript><span class=c1>// Dependencies</span>
<span class=kd>var</span> <span class=nx>system</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;system&#39;</span><span class=p>),</span>
    <span class=nx>webpage</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;webpage&#39;</span><span class=p>);</span>

<span class=c1>// Arguments check</span>
<span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>system</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>

<span class=k>if</span> <span class=p>(</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Load page</span>
  <span class=kd>var</span> <span class=nx>page</span> <span class=o>=</span> <span class=nx>webpage</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>

  <span class=c1>// Set viewport</span>
  <span class=nx>page</span><span class=p>.</span><span class=nx>viewportSize</span> <span class=o>=</span> <span class=p>{</span>
    <span class=nx>width</span><span class=o>:</span> <span class=mi>1024</span><span class=p>,</span>
    <span class=nx>height</span><span class=o>:</span> <span class=mi>800</span>
  <span class=p>};</span>

  <span class=nx>page</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>status</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>attempts</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=kd>function</span> <span class=nx>checkPageReady</span><span class=p>()</span> <span class=p>{</span>
      <span class=kd>var</span> <span class=nx>html</span><span class=p>;</span>

      <span class=c1>// Evaluate page</span>
      <span class=nx>html</span> <span class=o>=</span> <span class=nx>page</span><span class=p>.</span><span class=nx>evaluate</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=kd>var</span> <span class=nx>body</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByTagName</span><span class=p>(</span><span class=s1>&#39;body&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span>

        <span class=c1>// Return HTML when page is fully loaded</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s1>&#39;data-ready&#39;</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>return</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByTagName</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>].</span><span class=nx>outerHTML</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>});</span>

      <span class=c1>// Output HTML if defined and exit</span>
      <span class=k>if</span> <span class=p>(</span><span class=nx>html</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
        <span class=nx>phantom</span><span class=p>.</span><span class=nx>exit</span><span class=p>();</span>
      <span class=p>}</span>

      <span class=c1>// Break if too many attempts were made</span>
      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>attempts</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>attempts</span><span class=o>++</span><span class=p>;</span>

        <span class=c1>// Try again</span>
        <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>checkPageReady</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Failed to wait for the requested page to load&#39;</span><span class=p>);</span>
        <span class=nx>phantom</span><span class=p>.</span><span class=nx>exit</span><span class=p>();</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=nx>status</span> <span class=o>===</span> <span class=s1>&#39;success&#39;</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Check if page is fully loaded</span>
      <span class=nx>checkPageReady</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=c1>// Otherwise, if page cannot be found, exit</span>
      <span class=nx>phantom</span><span class=p>.</span><span class=nx>exit</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>});</span>
<span class=p>}</span></code></pre></div><p>The above is the script used by PhantomJS to open the AngularJS page before returning the HTML output to the middleware. Basically, the headless browser synchronously waits for the page to finish loading and then takes a snapshot of it. Internally, in your AngularJS app, you need to watch for the completion of all API requests and set a flag once all the content is loaded and rendered, for example, setting <code>data-ready</code> attribute in the <code>body</code> tag to true. I just used something I built previously for that - <a href=https://github.com/red-ant/angular-ra-pageload>angular-ra-pageload</a></p><p>If you restart your unicorn server and CURL it using the <em>escaped_fragment</em> url, you should see a rendered output instead of AngularJS templates. Please note that if you run your app on Heroku, you need to use <a href=https://github.com/heroku/heroku-buildpack-multi>multi-buildpack</a> so both Node and Ruby can run.</p><p>Anyway, from this experiment, it becomes clear that the pre-rendering is an expensive operation, that’s why I recommend delegating the task to a third-party service which handles the caching for you. Otherwise, you’ll need to do it yourself.</p></div><div class=blog-comment><div id=disqus_thread></div><script type=text/javascript>var disqus_identifier = "/blog/create-seo-friendly-angularjs-app/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></article><footer class=global-footer><div class=global-footer__container><nav class=global-footer-navigation><ul><li><a href=//au.linkedin.com/in/davidchin86 target=_blank>LinkedIn</a></li><li><a href=//github.com/davidchin target=_blank>GitHub</a></li><li><a href=//flickr.com/dyfchin target=_blank>Flickr</a></li><li><a href=/blog>Blog</a></li></ul></nav><aside class=fine-print-footer><div>&copy; All rights reserved.</div><div>Built with Jekyll, CoffeeScript, SASS &amp; Grunt. View <a href=//github.com/davidchin/davidchin.github.io target=_blank>source</a></div></aside></div></footer><!-- GA --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41589871-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');</script><!-- Disqus --><script>(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());</script><!-- CDN --><script src=https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js></script><!-- Packaged JS --><script src=/js/application.c54b.js></script></body></html>