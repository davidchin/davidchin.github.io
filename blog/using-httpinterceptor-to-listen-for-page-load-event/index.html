<!DOCTYPE html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content="I am a developer, specialising in front-end web and native application development."><title>Using HttpInterceptor to listen for page load event in AngularJS | David Chin</title><link rel=canonical href="http://davidchin.me/blog/using-httpinterceptor-to-listen-for-page-load-event/"><link rel=stylesheet href="http://fonts.googleapis.com/css?family=Fira+Sans:300,400,700,300italic,400italic,700italic"><link rel=stylesheet href=/css/application.2408.css><link rel=apple-touch-icon sizes=76x76 href=/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=152x152 href=/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=152x152 href=/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon-180x180.png><link rel="shortcut icon" type=image/vnd.microsoft.icon href="/favicon.ico"><script>window.disqus_shortname = "davidchin-blog"</script></head><body class=""><header class=global-header><div class=global-header__container><nav class=global-navigation><button id=navicon-button class=navicon-button><i class="navicon-button__icon ion-navicon"></i></button><ul class=global-navigation__menu><li><a href=/blog>Blog</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><a href="/" class=global-header__logo>David Chin</a></div></header><article><header class=page-header><div class=page-header__container><h1 class=page-header__title>Using HttpInterceptor to listen for page load event in AngularJS</h1></div></header><div class=page-content><div class=content-column><div class=blog-article><p class=blog-article__meta><strong>angularjs</strong> / 03 October 2014 / <a href=/blog/using-httpinterceptor-to-listen-for-page-load-event/#disqus_thread data-disqus-identifier="/blog/using-httpinterceptor-to-listen-for-page-load-event/">0 Comments</a></p><p>Often you need to make several GET API requests and fetch a few HTML partials to render an AngularJS page. To know when a page finishes loading, obviously you cannot just listen for <code>DOMContentLoaded</code> event, because AJAX calls happen afterwards. Instead, you can use a HttpInterceptor to monitor the completion of all GET requests when $location changes.</p><h2 id=how-it-works>How it works</h2><p>HttpInterceptor acts as middleware allowing you to do extra stuff before and after making a request and receiving a response. To achieve an outcome similar to page ‘ready’ event, you need to keep track of the number of requests made, and cross them off the list when they are fulfilled (successful or not).</p><h2 id=example>Example</h2><p>You can see an <a href="http://jsfiddle.net/dyfchin/sf7hqa52/">example</a> demonstrating the concept. Below is a snippet of the example.</p><div class=highlight><pre><code class=language-javascript data-lang=javascript><span class=nx>angular</span><span class=p>.</span><span class=nx>module</span><span class=p>(</span><span class=s1>&#39;loading&#39;</span><span class=p>,</span> <span class=p>[])</span>

  <span class=p>.</span><span class=nx>factory</span><span class=p>(</span><span class=s1>&#39;loadingInterceptor&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>$q</span><span class=p>,</span> <span class=nx>loadingProgress</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>pendingRequests</span> <span class=o>=</span> <span class=p>[];</span>

    <span class=kd>function</span> <span class=nx>onRequest</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>loadingProgress</span><span class=p>.</span><span class=nx>queue</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>

      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Pending request: &#39;</span> <span class=o>+</span> <span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
      
      <span class=k>return</span> <span class=nx>request</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>function</span> <span class=nx>onResponse</span><span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>loadingProgress</span><span class=p>.</span><span class=nx>dequeue</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>config</span><span class=p>);</span>

      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Completed request: &#39;</span> <span class=o>+</span> <span class=nx>response</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
      
      <span class=k>return</span> <span class=nx>response</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>function</span> <span class=nx>onError</span><span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>loadingProgress</span><span class=p>.</span><span class=nx>dequeue</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>config</span><span class=p>);</span>

      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Failed request: &#39;</span> <span class=o>+</span> <span class=nx>response</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>

      <span class=k>return</span> <span class=nx>$q</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=p>{</span>
      <span class=nx>request</span><span class=o>:</span> <span class=nx>onRequest</span><span class=p>,</span>
      <span class=nx>response</span><span class=o>:</span> <span class=nx>onResponse</span><span class=p>,</span>
      <span class=nx>requestError</span><span class=o>:</span> <span class=nx>onError</span><span class=p>,</span>
      <span class=nx>responseError</span><span class=o>:</span> <span class=nx>onError</span>
    <span class=p>};</span>
  <span class=p>})</span>

  <span class=p>.</span><span class=nx>factory</span><span class=p>(</span><span class=s1>&#39;loadingProgress&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>$rootScope</span><span class=p>,</span> <span class=nx>$timeout</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>{</span>
      <span class=nx>init</span><span class=o>:</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span> <span class=o>=</span> <span class=p>[];</span>
      <span class=p>},</span>

      <span class=nx>reset</span><span class=o>:</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>loaded</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
      <span class=p>},</span>

      <span class=nx>queue</span><span class=o>:</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Add to queue if it is a GET request</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s1>&#39;GET&#39;</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
          <span class=k>this</span><span class=p>.</span><span class=nx>loaded</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>},</span>

      <span class=nx>dequeue</span><span class=o>:</span> <span class=kd>function</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>var</span> <span class=nx>index</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>

        <span class=c1>// Remove from queue</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>index</span> <span class=o>!==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>index</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// Wait for the next digest cycle</span>
        <span class=nx>$timeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
          <span class=c1>// If there are no pending requests, notify child scopes</span>
          <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pendingRequests</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>loaded</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>this</span><span class=p>.</span><span class=nx>notify</span><span class=p>(</span><span class=s1>&#39;pageReady&#39;</span><span class=p>);</span>
            <span class=k>this</span><span class=p>.</span><span class=nx>loaded</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
          <span class=p>}</span>
        <span class=p>}.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>));</span>
      <span class=p>},</span>

      <span class=nx>notify</span><span class=o>:</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>$rootScope</span><span class=p>.</span><span class=nx>$broadcast</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>$rootScope</span><span class=p>,</span> <span class=nx>arguments</span><span class=p>);</span>
      <span class=p>}</span>
    <span class=p>};</span>
  <span class=p>});</span></code></pre></div><p>And this is an example view/controller which makes some http calls, which get tracked by <code>loadingProgress</code> service through <code>loadingInterceptor</code>.</p><div class=highlight><pre><code class=language-html data-lang=html><span class=nt>&lt;div</span> <span class=na>ng-controller=</span><span class=s>&quot;AppController&quot;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;strong</span> <span class=na>ng-show=</span><span class=s>&quot;loadingProgress.loaded&quot;</span><span class=nt>&gt;</span>Loaded!<span class=nt>&lt;/strong&gt;</span>
    <span class=nt>&lt;strong</span> <span class=na>ng-hide=</span><span class=s>&quot;loadingProgress.loaded&quot;</span><span class=nt>&gt;</span>Loading...<span class=nt>&lt;/strong&gt;</span>
    
    <span class=c>&lt;!-- Load a HTML partial --&gt;</span>
    <span class=nt>&lt;ng-include</span> <span class=na>src=</span><span class=s>&quot;&#39;http://fiddle.jshell.net/echo/html/&#39;&quot;</span><span class=nt>&gt;&lt;/ng-include&gt;</span>
<span class=nt>&lt;/div&gt;</span></code></pre></div><div class=highlight><pre><code class=language-javascript data-lang=javascript><span class=nx>angular</span><span class=p>.</span><span class=nx>module</span><span class=p>(</span><span class=s1>&#39;app&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;ngRoute&#39;</span><span class=p>,</span> <span class=s1>&#39;loading&#39;</span><span class=p>])</span>

  <span class=p>.</span><span class=nx>config</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>$httpProvider</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Register a http interceptor</span>
    <span class=nx>$httpProvider</span><span class=p>.</span><span class=nx>interceptors</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;loadingInterceptor&#39;</span><span class=p>);</span>
  <span class=p>})</span>

  <span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>$rootScope</span><span class=p>,</span> <span class=nx>loadingProgress</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Init loadingProgress service</span>
    <span class=nx>loadingProgress</span><span class=p>.</span><span class=nx>init</span><span class=p>();</span>

    <span class=c1>// Reset loading queue on route change</span>
    <span class=nx>$rootScope</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=s1>&#39;$routeChangeSuccess&#39;</span><span class=p>,</span> <span class=nx>loadingProgress</span><span class=p>.</span><span class=nx>reset</span><span class=p>);</span>
    <span class=nx>$rootScope</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=s1>&#39;$routeUpdate&#39;</span><span class=p>,</span> <span class=nx>loadingProgress</span><span class=p>.</span><span class=nx>reset</span><span class=p>);</span>
  <span class=p>})</span>

  <span class=p>.</span><span class=nx>controller</span><span class=p>(</span><span class=s1>&#39;AppController&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>$scope</span><span class=p>,</span> <span class=nx>$http</span><span class=p>,</span> <span class=nx>loadingProgress</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Make a http GET request</span>
    <span class=nx>$http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;http://fiddle.jshell.net/echo/json/&#39;</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// Make another http GET request after the first one</span>
        <span class=k>return</span> <span class=nx>$http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;http://fiddle.jshell.net/echo/xml/&#39;</span><span class=p>);</span>
      <span class=p>});</span>

    <span class=c1>// Listen for &quot;pageReady&quot; event</span>
    <span class=nx>$scope</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=s1>&#39;pageReady&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Completed all http requests&#39;</span><span class=p>);</span>
    <span class=p>});</span>

    <span class=c1>// Assign to scope for demo purpose</span>
    <span class=nx>$scope</span><span class=p>.</span><span class=nx>loadingProgress</span> <span class=o>=</span> <span class=nx>loadingProgress</span><span class=p>;</span>
  <span class=p>});</span></code></pre></div><p>As you can see, you can broadcast a ‘ready’ event from the $rootScope to inform child scopes that all GET requests are fulfilled. Such event is useful in many cases. For example, you might want to scroll to a specific element on the page; but you can only do it once the page finishes loading, otherwise its offset position would get miscalculated. You might also want to implement a site-wide loading indicator, toggling its visibility when the <code>ready</code> event gets fired.</p><h2 id=download>Download</h2><p>I needed a similar functionality for my day job - to notify NewRelic when a page finishes loading, otherwise the timing report seems unrealistic. I moved it into a <a href=https://github.com/red-ant/angular-ra-pageload>Bower component</a> so it can be shared across different Angular projects. You can check out a <a href="http://jsfiddle.net/dyfchin/3a1updw0/">demo here</a>. To use it in your project, try</p><pre><code>bower install angular-ra-pageload
</code></pre></div><div class=blog-comment><div id=disqus_thread></div><script type=text/javascript>var disqus_identifier = "/blog/using-httpinterceptor-to-listen-for-page-load-event/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></article><footer class=global-footer><div class=global-footer__container><nav class=global-footer-navigation><ul><li><a href=//au.linkedin.com/in/davidchin86 target=_blank>LinkedIn</a></li><li><a href=//github.com/davidchin target=_blank>GitHub</a></li><li><a href=//flickr.com/dyfchin target=_blank>Flickr</a></li><li><a href=/blog>Blog</a></li></ul></nav><aside class=fine-print-footer><div>&copy; All rights reserved.</div><div>Built with Jekyll, CoffeeScript, SASS &amp; Grunt. View <a href=//github.com/davidchin/davidchin.github.io target=_blank>source</a></div></aside></div></footer><!-- GA --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41589871-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');</script><!-- Disqus --><script>(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());</script><!-- CDN --><script src=https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js></script><!-- Packaged JS --><script src=/js/application.c54b.js></script></body></html>